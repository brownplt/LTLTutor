<!DOCTYPE html>
<html>

<head>
    <title>LTL Stepper</title>

    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Include Bootstrap JS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="{{ url_for('static', filename='js/ltlhljs.js') }}"></script>

    <script src="{{ url_for('static', filename='js/common-functionality.js') }}"></script>

    <script>
        hljs.registerLanguage('ltl', ltlSyntaxDefs);
        hljs.highlightAll();
    </script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <meta name="description" content="Learn Linear Temporal Logic (LTL) with this interactive tutor.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        #statecontainer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .formula-tree-container,
        .trace-container {
            justify-content: center;
        }

        /* Center align .mermaid divs */
        #statecontainer .mermaid {
            margin: 0 auto;
            /* Centers the div within its flex container */
            display: block;
            /* Ensures the div is treated as a block-level element */
        }

        .cycle-state-col {
            background-color: #f3f7fa !important;
            /* much lighter blue/gray shade */


            /* maybe some on-hover tooltip to say this state is part of a cycle? */

        }

        .satformula {
            border: 2px dashed #28a745;
            /* green dashed border */
            border-radius: 6px;
            padding: 4px 8px;
            color: #155724;

            display: inline-block;
        }

        .unsatformula {

            border: 2px solid #dc3545;
            /* red solid border */
            border-radius: 6px;
            padding: 4px 8px;

            display: inline-block;
        }

        /* Matrix view text colors */
        .matrix-satisfied {
            color: #28a745 !important;
            font-weight: bold;
        }

        .matrix-unsatisfied {
            color: #dc3545 !important;
            font-weight: bold;
        }

        .stepper-container {
            transition: opacity 0.25s ease, transform 0.25s ease;
            opacity: 0;
            transform: translateY(8px);
            display: none;
        }

        .stepper-container.active-step {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .stepper-container.leaving-step {
            display: block;
            opacity: 0;
            transform: translateY(-4px);
        }

        .tree-highlight {
            box-shadow: 0 0 0 3px #ffe58f;
            border-radius: 8px;
            animation: flashHighlight 1s ease;
        }

        @keyframes flashHighlight {
            0% {
                box-shadow: 0 0 0 3px #ffe58f;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 229, 143, 0);
            }
        }
    </style>

</head>

<body>
    <div class="container">
        {% include 'navbar.html' %}

        <div id="Controls">



            {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
            {% endif %}


            <!-- Modal -->
            <div class="modal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Load Stepper with a new LTL Formula and Trace
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="{{ request.path }}" method="POST">
                                <div class="form-group">
                                    <label for="formula">LTL Formula:</label>
                                    <input type="text" class="form-control" id="formula" name="formula" {% if formula %}
                                        value="{{ formula }}" {% endif %}>
                                </div>
                                <div class="form-group">
                                    <label for="trace">Trace:</label>
                                    <input type="text" class="form-control" id="trace" name="trace" {% if trace %}
                                        value="{{ trace }}" {% endif %}>
                                </div>
                                <button type="submit" class="btn btn-primary">Load Stepper</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


        </div>


        <ul class="nav nav-tabs mb-3 mt-4" id="stepperTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="stepper-tab" data-toggle="tab" href="#stepper-view" role="tab">Stepper
                    View</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="table-tab" data-toggle="tab" href="#table-view" role="tab">Table View</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="matrix-tab" data-toggle="tab" href="#matrix-view" role="tab">Matrix View<sup>Beta</sup></a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- ================================ -->
            <!-- STEPPER VIEW - Interactive stepping through formula satisfaction -->
            <!-- ================================ -->
            <div class="tab-pane fade show active" id="stepper-view" role="tabpanel">
                <!-- Stepper view lets you see the entire trace at once, and each tree state one by one. -->

                <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
                    <div id="stepperProgress" class="text-muted small" aria-live="polite"></div>
                    <div class="text-muted small mt-1 mt-sm-0"><i class="fas fa-keyboard mr-1"></i>Use ← / → or the buttons to move between states.</div>
                </div>

                <div id="statecontainer">
                    {% for ps in prefixstates + cyclestates %}
                    <div class="container stepper-container">

                        <div class="formula-tree-container mt-2">
                            <h4><span class="help float-right"> This tree represents the formula <code> {{formula}} </code>,
                                    structuring its sub-formulae in a hierarchical manner. Each node in the tree is
                                    represented
                                    by a green box if it is satisfied, and an orange box with two lines if it is not
                                    satisfied.</span> </h4>

                            <div>
                                <pre class="mermaid" id="{{ps.id}}tree"> {{ ps.treeAsMermaid | safe}}  </pre>
                            </div>
                        </div>

                        <hr>

                        <div class="trace-container mt-2">
                            <h4><span class="help float-right"> By clicking the <code>Previous State</code> and <code>Next
                                    State</code>
                                    buttons, you can examine the formula's satisfaction at different points in this
                                    trace.
                                </span></h4>
                            <pre class="mermaid" id="{{ps.id}}trace">{{ ps.traceAsMermaid | safe }}</pre>
                            <br>
                            <div class="btn-group d-flex justify-content-center" role="group">
                                <button class="prev btn btn-primary" title="Previous State"><i
                                        class="fas fa-arrow-left"></i></button>
                                <button class="next btn btn-primary" title="Next State"><i
                                        class="fas fa-arrow-right"></i></button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- ================================ -->
            <!-- TABLE VIEW - Detailed formula view with satisfaction highlighting -->
            <!-- ================================ -->
            <div class="tab-pane fade" id="table-view" role="tabpanel">
                {% if matrix_data.subformulae %}
                    <p>
                    Sub-formulae are demarcated by their bounding boxes, which
                    indicate whether they are <span class="satformula">satisfied</span> or
                                        <span class="unsatformula">unsatisfied</span>.
                    </p>
                    <!-- Detailed table view -->
                    <table class="table table-bordered" id="stateTable">
                        <thead>
                            <tr>
                                <th class="w-auto"></th>
                                {% for ps in prefixstates %}
                                    <th></th>
                                {% endfor %}
                                {% if cyclestates %}
                                    <th class="cycle-state-col" colspan="{{ cyclestates|length }}">Cycle</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th class="w-auto">Trace State</th>
                                {% for ps in prefixstates %}
                                    <td><pre>{{ ps.formattedTraceAssignment }}</pre></td>
                                {% endfor %}
                                {% for ps in cyclestates %}
                                    <td class="cycle-state-col"><pre>{{ ps.formattedTraceAssignment }}</pre></td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <th class="w-auto">
                                    Formula
                                    </span>
                                </th>
                                {% for ps in prefixstates %}
                                    <td>
                                        {{ ps.formulaAsHTML | safe }}
                                    </td>
                                {% endfor %}
                                {% for ps in cyclestates %}
                                    <td class="cycle-state-col">
                                        {{ ps.formulaAsHTML | safe }}
                                    </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                {% else %}
                    <div class="alert alert-info">
                        <p><strong>No formula loaded.</strong></p>
                        <p>Please enter an LTL formula and trace to see the table view.</p>
                    </div>
                {% endif %}
            </div>
            <!-- ================================ -->
            <!-- MATRIX VIEW - Binary matrix display of subformula satisfaction over time -->
            <!-- ================================ -->
            <div class="tab-pane fade" id="matrix-view" role="tabpanel">
                <p>
                This matrix view shows how each subformula's satisfaction evolves over time.
                Each row represents a subformula, and each column represents a time step.
                Values are shown as <strong class="matrix-satisfied">1</strong> (satisfied) or <strong class="matrix-unsatisfied">0</strong> (unsatisfied).
                </p>
                
                {% if matrix_data.subformulae %}
                <!-- Matrix view table -->
                <table class="table table-bordered table-sm" id="matrixTable">
                    <thead>
                        <!-- Top header row for cycle indication -->
                        <tr>
                            <th class="w-auto"></th>
                            {% for ps in prefixstates %}
                                <th></th>
                            {% endfor %}
                            {% if cyclestates %}
                                <th class="cycle-state-col" colspan="{{ cyclestates|length }}">Cycle</th>
                            {% endif %}
                        </tr>
                        <!-- Time step numbers row -->
                        <tr>
                            <th class="w-auto">Subformula</th>
                            {% for i in range(prefixstates|length) %}
                                <th class="text-center">{{ i }}</th>
                            {% endfor %}
                            {% for i in range(cyclestates|length) %}
                                <th class="text-center cycle-state-col">{{ prefixstates|length + i }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row_data in matrix_data.rows %}
                            {% if row_data and 'subformula' in row_data and 'values' in row_data %}
                        <tr>
                            <td class="font-monospace"><code>{{ row_data['subformula'] }}</code></td>
                            {% for i in range(row_data['values']|length) %}
                                {% set value = row_data['values'][i] %}
                                {% if i < prefixstates|length %}
                                    <td class="text-center">
                                        <span class="{% if value == 1 %}matrix-satisfied{% else %}matrix-unsatisfied{% endif %}">{{ value }}</span>
                                    </td>
                                {% else %}
                                    <td class="text-center cycle-state-col">
                                        <span class="{% if value == 1 %}matrix-satisfied{% else %}matrix-unsatisfied{% endif %}">{{ value }}</span>
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <div class="alert alert-info">
                        <p><strong>No formula loaded.</strong></p>
                        <p>Please enter an LTL formula and trace to see the matrix view.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <hr>

    <script>
        $(document).ready(function () {

            //mermaid.initialize({ startOnLoad: true });
            mermaid.initialize({ startOnLoad: false });
            const ui_load_timeout_delay = 150;
            function renderMermaidDiagram(graphElements) {

                mermaid.run({
                    nodes: graphElements
                }).then((data) => {
                    graphElements.forEach(function (element) {
                        let $element = $(element);
                        $element.width($element.find('svg').css('max-width'));
                    });


                }).catch((err) => {
                    console.error("Error rendering mermaid diagram");
                    console.error(err);
                });
            };


            const stepperContainers = Array.from(document.querySelectorAll('.stepper-container'));
            const progressLabel = document.getElementById('stepperProgress');
            const transitionDuration = 250;
            let currentIndex = 0;

            if (!stepperContainers.length) {
                return;
            }

            stepperContainers.forEach((container, index) => {
                container.dataset.index = index;
                container.style.display = 'none';
            });

            function updateProgress() {
                if (!progressLabel) {
                    return;
                }
                progressLabel.textContent = `State ${currentIndex + 1} of ${stepperContainers.length}`;
            }

            function setButtonState() {
                stepperContainers.forEach((container, index) => {
                    const prevButton = container.querySelector('.prev');
                    const nextButton = container.querySelector('.next');

                    if (prevButton) {
                        prevButton.disabled = index === 0;
                    }
                    if (nextButton) {
                        nextButton.disabled = index === stepperContainers.length - 1;
                    }
                });
            }

            function renderDiagrams() {
                const activeContainer = stepperContainers[currentIndex];
                if (!activeContainer) {
                    return;
                }
                let to_render = activeContainer.querySelectorAll('.mermaid');
                renderMermaidDiagram(to_render);
            }

            function flashTree(container) {
                const tree = container.querySelector('.formula-tree-container');
                if (!tree) {
                    return;
                }
                tree.classList.remove('tree-highlight');
                // trigger reflow so animation can restart
                void tree.offsetWidth;
                tree.classList.add('tree-highlight');
            }

            function showContainer(newIndex) {
                if (newIndex === currentIndex || newIndex < 0 || newIndex >= stepperContainers.length) {
                    return;
                }

                const leavingContainer = stepperContainers[currentIndex];
                const enteringContainer = stepperContainers[newIndex];

                leavingContainer.classList.remove('active-step');
                leavingContainer.classList.add('leaving-step');
                enteringContainer.style.display = 'block';

                requestAnimationFrame(() => {
                    enteringContainer.classList.add('active-step');
                    enteringContainer.classList.remove('leaving-step');
                });

                setTimeout(() => {
                    leavingContainer.classList.remove('leaving-step');
                    leavingContainer.style.display = 'none';
                }, transitionDuration);

                currentIndex = newIndex;
                renderDiagrams();
                setButtonState();
                updateProgress();
                flashTree(enteringContainer);
            }

            function goToPrevious() {
                if (currentIndex > 0) {
                    showContainer(currentIndex - 1);
                }
            }

            function goToNext() {
                if (currentIndex < stepperContainers.length - 1) {
                    showContainer(currentIndex + 1);
                }
            }

            // Initialize first view
            stepperContainers[0].style.display = 'block';
            stepperContainers[0].classList.add('active-step');
            flashTree(stepperContainers[0]);
            renderDiagrams();
            setButtonState();
            updateProgress();

            document.querySelectorAll('.prev').forEach(function (element) {
                element.addEventListener('click', function (event) {
                    event.preventDefault();
                    goToPrevious();
                })
            });

            document.querySelectorAll('.next').forEach(function (element) {
                element.addEventListener('click', function (event) {
                    event.preventDefault();
                    goToNext();
                })
            });

            document.addEventListener('keydown', function (event) {
                const tag = event.target.tagName.toLowerCase();
                if (tag === 'input' || tag === 'textarea') {
                    return;
                }
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    goToPrevious();
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    goToNext();
                }
            });
        });
    </script>

    <div class="container mt-4 mb-4">
        <button type="button" class="btn btn-outline-secondary btn-block" data-toggle="modal" data-target="#exampleModal">
            <p class="text-muted"> Step through a different trace &bsol; formula pair </p>
        </button>
    </div>

    {% include 'footer.html' %}
</body>

</html>