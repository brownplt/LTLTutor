<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTL Tutor</title>

    <!-- Include Chart.js (already present) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.2"></script>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="{{ url_for('static', filename='js/common-functionality.js') }}"></script>
    <meta name="description" content="Learn Linear Temporal Logic (LTL) with this interactive tutor.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">

</head>

<body>

    <div class="container">
        {% include 'navbar.html' %}


        <div class="mt-4 mb-4">
            <h1 class="text-center">Your Profile</h1>
            <p class="text-center">
            In the last {{lookback_days}} days, you have 
            answered <span class="font-weight-bolder"> {{num_correct}} out of {{num_answered}} </span> question(s) correctly.
            </p>
        </div>
        <hr>

        <div class="btn-group btn-group-lg d-flex justify-content-center" role="group">
            <a href="/view/logs" class="btn btn-secondary">View Logs</a>
            <a href="/view/generatedexercises" class="btn btn-secondary">View Generated Exercises</a>
        </div>



        <hr>

        <!-- Misconception Trends Summary -->
        {% if misconception_trends %}
        <h3 class="mt-5">Misconception Trends Summary</h3>
        <p class="text-muted">Based on Bayesian Knowledge Tracing analysis comparing your recent (48h) vs. historical performance.</p>
        <div class="row">
            {% for misconception, trend in misconception_trends.items() %}
            {% if trend.score != 0 or misconception_weights_over_time[misconception]|length > 0 %}
            <div class="col-md-4 mb-3">
                <div class="card {% if trend.score >= 0.5 %}border-danger{% elif trend.score >= 0.2 %}border-warning{% elif trend.score <= -0.2 %}border-success{% else %}border-secondary{% endif %}">
                    <div class="card-body">
                        <h6 class="card-title">{{ misconception }}</h6>
                        <p class="card-text">
                            <span class="badge {% if trend.score >= 0.5 %}badge-danger{% elif trend.score >= 0.2 %}badge-warning{% elif trend.score <= -0.2 %}badge-success{% else %}badge-secondary{% endif %}">
                                {{ trend.label }}
                            </span>
                            {% if not trend.has_recent_data %}
                            <span class="badge badge-light" title="Based on historical data (no activity in last 48h)">Historical</span>
                            {% endif %}
                        </p>
                        <small class="text-muted">
                            {% if trend.score > 0 %}
                                ↑ Trend score: {{ "%.2f"|format(trend.score) }}
                            {% elif trend.score < 0 %}
                                ↓ Trend score: {{ "%.2f"|format(trend.score) }}
                            {% else %}
                                — Stable (score: 0.00)
                            {% endif %}
                            {% if not trend.has_recent_data %}
                                <br><em>No activity in last 48h</em>
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <hr>
        {% endif %}


        <h3 class="mt-5">Estimated Misconceptions Over Time</h3>
        <p class="text-muted">
            This chart shows how your misconception likelihood has evolved over time using 
            <a href="https://doi.org/10.1007/BF01099821" target="_blank" rel="noopener noreferrer" aria-label="Read about Bayesian Knowledge Tracing research paper">Bayesian Knowledge Tracing</a> 
            combined with spaced repetition principles.
        </p>
        <canvas id="allMisconceptionsChart"></canvas>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Prepare data for all misconceptions
            const misconceptionData = {
                {% for misconception, weights in misconception_weights_over_time.items() %}
                    "{{ misconception }}" : {{ weights | tojson }},
                {% endfor %}
            };

            
            // Find the latest timestamp to compute "days ago"
            let latestTimestamp = 0;
            for (const weights of Object.values(misconceptionData)) {
                for (const w of weights) {
                    const t = new Date(w.time).getTime();
                    if (t > latestTimestamp) latestTimestamp = t;
                }
            }

            // Build datasets for Chart.js
            const datasets = [];
            const colors = [
                'rgb(75, 192, 192)', 'rgb(255, 99, 132)', 'rgb(255, 205, 86)', 'rgb(54, 162, 235)',
                'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgb(201, 203, 207)'
            ];
            let colorIdx = 0;
            // Helper function to convert hours to log scale position
            // This spreads recent data (hours) more while compressing older data (days/weeks)
            function hoursToLogPosition(hours) {
                // Add 1 to avoid log(0), negate so recent (0 hours) is on right
                return -Math.log10(Math.max(0.1, hours) + 1);
            }

            for (const [misconception, weights] of Object.entries(misconceptionData)) {
                if (weights.length > 0) {
                    datasets.push({
                        label: misconception,
                        data: weights.map(w => {
                            const t = new Date(w.time).getTime();
                            const hoursAgo = (latestTimestamp - t) / (1000 * 60 * 60);
                            const logPosition = hoursToLogPosition(hoursAgo);
                            const jitter = (Math.random() - 0.5) * 0.02; // smaller jitter for log scale
                            return { x: logPosition + jitter, y: w.weight };
                        }),
                        fill: false,
                        borderColor: colors[colorIdx % colors.length],
                        tension: 0.1
                    });
                    colorIdx++;
                }
            }

            const ctx = document.getElementById('allMisconceptionsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 0.5,
                                    yMax: 0.5,
                                    borderColor: 'rgba(120,120,120,0.5)',
                                    borderWidth: 2,
                                    borderDash: [4, 6],
                                    label: {
                                        content: 'Threshold (0.5)',
                                        enabled: true,
                                        position: 'end',
                                        color: '#666',
                                        backgroundColor: 'rgba(255,255,255,0.7)'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Time Ago (Log Scale)' },
                            reverse: false,
                            // Log scale: -log10(hours+1), so 0 hours = 0, 9 hours ≈ -1, 99 hours ≈ -2
                            min: -3,        // ~999 hours ago (~41 days)
                            max: 0.1,       // now
                            ticks: {
                                callback: function(value) {
                                    // Convert log position back to hours for display
                                    // value = -log10(hours + 1), so hours = 10^(-value) - 1
                                    const hours = Math.pow(10, -value) - 1;
                                    if (hours < 1) return 'Now';
                                    if (hours < 24) return Math.round(hours) + 'h ago';
                                    if (hours < 168) return Math.round(hours / 24) + 'd ago';
                                    return Math.round(hours / 168) + 'w ago';
                                },
                                // Show ticks at meaningful intervals
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: { display: true, text: 'Misconception Likelihood' },
                           // min: 0,
                           // max: 1,
                            ticks: {
                                callback: function(value) {
                                    // if (value === 1) {
                                    //     return 'More likely you have this misconception';
                                    // } else if (value === 0.5) {
                                    //     return 'Threshold';
                                    // } else if (value === 0) {
                                    //     return 'Less likely you have this misconception';
                                    // } else {
                                    //     return '';
                                    // }
                                    return '';
                                },
                                //stepSize: 0.5, // Only show ticks at 0, 0.5, 1
                                //autoSkip: false
                            }
                        }
                    }
                }
            });
        });
        </script>
    </div>
</body>
</html>