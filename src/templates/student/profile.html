<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTL Tutor</title>



    <!-- Include Chart.js (already present) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="{{ url_for('static', filename='js/common-functionality.js') }}"></script>
    <meta name="description" content="Learn Linear Temporal Logic (LTL) with this interactive tutor.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">

</head>

<body>

    <div class="container">
        {% include 'navbar.html' %}


        <div class="mt-4 mb-4">
            <h1 class="text-center">Your Profile</h1>
            <p class="text-center">
            In the last {{lookback_days}} days, you have 
            answered <span class="font-weight-bolder"> {{num_correct}} out of {{num_answered}} </span> question(s) correctly.
            </p>
        </div>
        <hr>

        <div class="btn-group btn-group-lg d-flex justify-content-center" role="group">
            <a href="/view/logs" class="btn btn-secondary">View Logs</a>
            <a href="/view/generatedexercises" class="btn btn-secondary">View Generated Exercises</a>
        </div>



        <hr>


        {% for misconception, weights in misconception_weights_over_time.items() %}

        {% if weights|length > 0 %}
        <p class="lead toggle-arrow collapsed" data-toggle="collapse"
            href="#estimatedMisconceptionsDiv{{misconception}}" role="button" aria-expanded="false"
            aria-controls="estimatedMisconceptionsDiv{{misconception}}"> Estimation of <code>{{misconception}}</code>
            over time <span class="help">  <a href="https://arxiv.org/abs/2211.01677">You can learn more about what this misconception means here.</a>  </span></p>
        <div class="collapse" id="estimatedMisconceptionsDiv{{misconception}}">
            <canvas id="estimatedMisconceptions{{misconception}}"></canvas>

            <script>
                var ctx = document.getElementById('estimatedMisconceptions{{misconception}}').getContext('2d');
                var weightsData = {{ weights | tojson }};

                var dataWithTimestamps = weightsData.map(function (weight) {
                    return { x: new Date(weight["time"]).getTime(), y: weight["weight"] };
                });

                // Calculate minimum timestamp and subtract one hour
                var minTimestamp = Math.min(...dataWithTimestamps.map(data => data.x)) - 360000; // 360000 milliseconds = 6 mins

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: '{{ misconception }}',
                            data: dataWithTimestamps,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)', // Line color
                            pointBackgroundColor: 'rgb(25, 100, 100)', // Darker color for points
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'linear', // Use a linear scale for the x-axis
                                position: 'bottom', // Position the x-axis at the bottom
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                min: minTimestamp, // Set the calculated minimum timestamp as the start of the x-axis
                            }
                        }
                    }
                });
            </script>
        </div>

        {% endif %}
        {% endfor %}
        <hr>

        <h3 class="mt-5">Estimated Misconceptions Over Time</h3>
        <canvas id="allMisconceptionsChart"></canvas>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Prepare data for all misconceptions
            const misconceptionData = {
                {% for misconception, weights in misconception_weights_over_time.items() %}
                    "{{ misconception }}": {{ weights | tojson }},
                {% endfor %}
            };

            // Find the latest timestamp to compute "days ago"
            let latestTimestamp = 0;
            for (const weights of Object.values(misconceptionData)) {
                for (const w of weights) {
                    const t = new Date(w.time).getTime();
                    if (t > latestTimestamp) latestTimestamp = t;
                }
            }

            // Build datasets for Chart.js
            const datasets = [];
            const colors = [
                'rgb(75, 192, 192)', 'rgb(255, 99, 132)', 'rgb(255, 205, 86)', 'rgb(54, 162, 235)',
                'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgb(201, 203, 207)'
            ];
            let colorIdx = 0;
            for (const [misconception, weights] of Object.entries(misconceptionData)) {
                if (weights.length > 0) {
                    datasets.push({
                        label: misconception,
                        data: weights.map(w => {
                            const t = new Date(w.time).getTime();
                            // Calculate days ago (rounded to 1 decimal)
                            const daysAgo = (latestTimestamp - t) / (1000 * 60 * 60 * 24);
                            return { x: -daysAgo, y: w.weight }; // negative so "0" is today, -N is N days ago
                        }),
                        fill: false,
                        borderColor: colors[colorIdx % colors.length],
                        tension: 0.1
                    });
                    colorIdx++;
                }
            }

            const ctx = document.getElementById('allMisconceptionsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Days Ago' },
                            reverse: true, // So 0 (today) is on the right, N days ago on the left
                            ticks: {
                                callback: function(value) {
                                    return Math.abs(value).toFixed(1);
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Estimated Weight' }
                        }
                    }
                }
            });
        </script>


    </div>
    {% include 'footer.html' %}

</body>

</html>